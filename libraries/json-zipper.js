var jsonZipper=function(e,i){var t=this,r=[],n=i&&"boolean"!=typeof i?i:{};t.zip=function(){if("zipable"===t.status){if(t.uzOpts={I:[],A:t.isArray,eC:[],iC:[]},t.isArray)for(var e=0,i=t.JO.length;e<i;)a(t.JO[e++]);else a(t.JO);return t.status="zipped",{M:r,D:t.JO,O:t.uzOpts}}return!1},t.unzip=function(){if("unzipable"===t.status){if(t.isArray)for(var e=0,i=t.JO.length;e<i;)O(t.JO[e++]);else O(t.JO);return t.status="unzipped",t.JO}return!1},t.compress=function(e){if("compressing"===t.status)t.JO.push(e),a(e);else{if("ready to load object"!==t.status)return!1;t.isArray=!0,t.uzOpts={I:[],A:t.isArray,eC:[],iC:[]},t.status="compressing",t.JO=[],t.JO.push(e),a(e)}return{M:r,D:t.JO,O:t.uzOpts}};var s=!1,d=[];t.extract=function(e){return"unzipable"!==t.status&&"zipped"!==t.status||(d.indexOf(e)>-1?f=t.JO[e]:(s&&s+1===e||c(e),O(t.JO[e]),d.push(e)),s=e),t.JO[e]},t.length=function(){return JSON.stringify(t.JO).length+(r?JSON.stringify(r).length:0)},t.options=function(e,i){t.identifiers=e.identifiers||[],t.isArray=e.isArray||i,t.exclude=e.exclude||[],t.include=e.include||[],t.remove=e.remove||!1,t.add=e.add||!1},t.load=function(e,i){t.startLength=0,r=[];try{var n=JSON.stringify(e);t.startLength=n.length,t.JO=JSON.parse(n)}catch(e){throw"The json object has recursive references or is too big to load into memory"}t.status="zipable",i&&(t.JO.D&&t.JO.O&&t.JO.M?(r=t.JO.M,t.identifiers=t.JO.O.I||[],t.isArray=t.JO.O.A,t.exclude=t.JO.O.eC||!1,t.include=t.JO.O.iC||!1,t.JO=t.JO.D,t.remove=!1,t.add=!1,t.status="unzipable"):t.options(i,e.constructor===Array)),f=!1,u=!1};var o=function(e,i){var n=r.indexOf(e);if(n<0){if(i)return r.push(e)-1;if(t.exclude.indexOf(e)>-1)return t.uzOpts.eC.push(e),e;n=r.push(e)-1,t.identifiers.indexOf(e)>-1&&t.uzOpts.I.push(n),t.include.indexOf(e)>-1&&t.uzOpts.iC.push(n)}return n},f=!1,u=!1,a=function(e){l(e);var i=Object.keys(e),n=!!f,s="",d=0;for(xend=t.identifiers.length;d<xend;d++){var a=t.identifiers[d];e[a]=o(e[a],1),s+=e[a]}for(n&&u&&u===s||(n=!1,f=e,u=s),d=0,iend=i.length;d<iend;d++){var O=i[d];if(t.remove&&t.remove.indexOf(O)>-1)delete e[O];else{var c=o(O);!n||r[f[c]]!==e[O]&&f[c]!==e[O]?t.include.indexOf(O)>-1?(t.identifiers.indexOf(O)>-1?e[c]=e[O]:e[c]=o(e[O],1),delete e[O]):c!==O&&(e[c]=e[O],delete e[O]):delete e[O]}}},O=function(e){if(e!==f){l(e);var i=!!t.isArray&&p(f,e),n=Object.keys(e);if(i)v(f,e);else if(t.identifiers){var s=0;for(xend=t.identifiers.length;s<xend;s++){var d=t.identifiers[s];e[d]=r[e[d]]}}var o=0;for(iend=n.length;o<iend;o++){var u=1*n[o];e[u],t.remove&&t.remove.indexOf(u)>-1?delete e[u]:t.exclude.indexOf(u)>-1?(e[u]=e[u],t.include.indexOf(u)>-1&&(e[u]=r[e[u]])):(t.include.indexOf(u)>-1?e[r[u]]=r[e[u]]:e[r[u]]=e[u],delete e[u])}f=e}},l=function(e){if(t.add)for(var i in t.add)void 0!==t.add[i]&&("function"==typeof t.add[i]?e[i]=t.add[i](e):e[i]=t.add[i])},c=function(e){if(e>0){var i=0;for(xend=t.identifiers.length;i<xend;i++)if(void 0===t.JO[e][t.identifiers[i]])return void c(e-1);O(t.JO[e])}else O(t.JO[0])},p=function(e,i){if(!(t.identifiers&&e&&i&&e!==i))return!1;var n=0;for(xend=t.identifiers.length;n<xend;n++){var s=t.identifiers[n],d=r[t.identifiers[n]];if(void 0===e[d]||void 0!==i[s]&&r[i[s]]!==e[d])return!1}return!0},v=function(e,i){for(var t in e)void 0===i[t]&&(i[t]=e[t])};t.setID=n.setID||!1,t.options(n,e.constructor===Array),t.status="ready to load object",e&&"object"==typeof e&&(i&&"boolean"==typeof i?t.load(e,!0):t.load(e,!1))};